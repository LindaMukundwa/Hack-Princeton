<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="expires" content="0" />
    <title>MIDIPlayer - Air Piano Mode</title>
    <!-- midi.js css -->
    <link href="css/MIDIPlayer.css" rel="stylesheet" type="text/css" />
    <!-- shim -->
    <script src="inc/shim/Base64.js" type="text/javascript"></script>
    <script src="inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!-- jasmid package -->
    <script src="inc/jasmid/stream.js"></script>
    <script src="inc/jasmid/midifile.js"></script>
    <script src="inc/jasmid/replayer.js"></script>
    <!-- midi.js package -->
    <script src="js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="js/midi/gm.js" type="text/javascript"></script>
    <script src="js/midi/loader.js" type="text/javascript"></script>
    <script src="js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <script src="js/midi/player.js" type="text/javascript"></script>
    <script src="js/midi/synesthesia.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="js/util/jquery.js"></script>
    <script src="js/util/songs.js"></script>
    <script src="js/util/pianistPos.js"></script>
    <!-- includes -->
    <script src="inc/timer.js" type="text/javascript"></script>
    <script src="inc/colorspace.js" type="text/javascript"></script>
    <script src="inc/event.js" type="text/javascript"></script>
</head>

<body id="body">
    <!-- Preloader -->
    <div id="preloader">
            <div id="status">
                    <p class="preloader-p">Loading...</p>
                    <div class="preloader" aria-busy="true" aria-label="Loading, please wait." role="progressbar"></div>
            </div>
    </div>
    <!-- ./Preloader -->
    <div id="info">
        Space Pianist MIDI Player made with <a href="https://threejs.org" target="_blank" rel="noopener">three.js</a></br>
        Drag and drop your MIDI files to play.
        <div id="songname"></div>
        <div id="pianoLoading"></div>
    </div>
    <div id="bot-div" style="position: fixed;bottom: 0; left:0;width: 100%;">
        <div class="player_bar">
            <div class="player" style="height: 42px; box-shadow: 0 -1px #000; margin-bottom: 0;">
                <div class="time-controls" style="float: left; margin: 0; position: relative; top: 5px; display: flex">
                    <span id="capsule">
                        <span id="cursor">
                            <p id="time1" class="time">0:00</p>
                        </span>
                        <p id="time2" class="time" style="float:right">-0:00</p>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <!-- Sheet Music Display (OSMD) -->
    <div id="sheet-music-container" style="position: fixed; top: 80px; left: 10px; width: 400px; height: 300px; background: rgba(255,255,255,0.95); z-index: 1000; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); overflow: auto;"></div>

    <!-- OpenSheetMusicDisplay -->
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.4/build/opensheetmusicdisplay.min.js"></script>
    <script>
        var static_url = "./"; //for django adapt {% static %}
    </script>
    
    <!-- MediaPipe Hands (Primary) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- TensorFlow.js (Fallback) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    
    <script type="module" src="js/main.js"></script>
    <script>
    // Sheet music logi: load and render MusicXML via OSMD
    // call showSheetMusic(midiFileName) when a MIDI file is loaded/played
    let osmd = null;
    async function showSheetMusic(midiFileName) {
        console.log('Showing sheet music for:', midiFileName); // Debug log
        const container = document.getElementById('sheet-music-container');
        
        // Initialize OSMD if needed
        if (!osmd) {
            osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(container, {
                drawingParameters: 'compact',
                autoResize: true,
                drawTitle: true
            });
        }

        try {
            // Only proceed if sheet music is enabled in settings
            if (window.settings && !window.settings['Show sheet music']) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // 1. Search Flat.io for a matching score
            console.log('Searching Flat.io for:', midiFileName); // Debug log
            const searchRes = await fetch(`/api/flat/search?q=${encodeURIComponent(midiFileName)}`);
            if (!searchRes.ok) throw new Error('Flat.io search failed');
            const searchData = await searchRes.json();
            if (!searchData || !searchData.length) throw new Error('No sheet music found on Flat.io');
            
            // 2. Get the first score's MusicXML
            const scoreId = searchData[0].id;
            console.log('Found score ID:', scoreId); // Debug log
            const xmlRes = await fetch(`/api/flat/musicxml?id=${encodeURIComponent(scoreId)}`);
            if (!xmlRes.ok) throw new Error('Failed to fetch MusicXML from Flat.io');
            const musicXML = await xmlRes.text();
            
            await osmd.load(musicXML);
            osmd.render();
        } catch (e) {
            container.innerHTML = '<div style="color:red;padding:1em;">Sheet music unavailable.<br>' + e.message + '</div>';
        }
    }
    function hideSheetMusic() {
        const container = document.getElementById('sheet-music-container');
        container.style.display = 'none';
        if (osmd) osmd.clear();
    }
    // To sync playback position call osmd.cursor.show() and osmd.cursor.next() as MIDI plays
    // See main.js for integration.
    </script>
</body>
</html>